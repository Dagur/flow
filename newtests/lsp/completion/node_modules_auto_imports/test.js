/*
 * @flow
 * @format
 */

import type {SuiteType} from '../../../Tester';
const path = require('path');
const {suite, test} = require('../../../Tester');

module.exports = (suite(
  ({
    lspStartAndConnect,
    lspStart,
    lspRequest,
    lspInitializeParams,
    lspRequestAndWaitUntilResponse,
    addFiles,
    addCode,
    lspIgnoreStatusAndCancellation,
  }) => [
    test('textDocument/completion with autoimports', [
      addFiles(
        'nested/bar/baz.js',
        'nested/node_modules',
        'nested/inner/node_modules/boo/package.json',
        'nested/inner/node_modules/boo/index.js',
        'node_modules/toplevel/package.json',
        'node_modules/toplevel/Toplevel.js',
        'third_party/node_modules/foo/package.json',
        'third_party/node_modules/foo/index.js',
      ),
      lspStartAndConnect(),
      lspRequestAndWaitUntilResponse('textDocument/completion', {
        textDocument: {uri: '<PLACEHOLDER_PROJECT_URL>/nested/bar/baz.js'},
        position: {line: 2, character: 7},
        context: {triggerKind: 1},
      }).verifyLSPMessageSnapshot(
        path.join(
          __dirname,
          '__snapshots__',
          'completion_with_auto_imports_toplevel.json',
        ),
        [
          'textDocument/publishDiagnostics',
          'window/showStatus',
          '$/cancelRequest',
        ],
      ),
      lspRequestAndWaitUntilResponse('textDocument/completion', {
        textDocument: {uri: '<PLACEHOLDER_PROJECT_URL>/nested/bar/baz.js'},
        position: {line: 3, character: 7},
        context: {triggerKind: 1},
      }).verifyLSPMessageSnapshot(
        // TODO: We do not handle autoimports with symlinked node_modules well.
        // The result from package foo should be able to imported without relative path.
        path.join(
          __dirname,
          '__snapshots__',
          'completion_with_auto_imports_nested.json',
        ),
        [
          'textDocument/publishDiagnostics',
          'window/showStatus',
          '$/cancelRequest',
        ],
      ),
    ]),
  ],
): SuiteType);
